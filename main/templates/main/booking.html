{% extends 'base.html' %}
{% load static %}

{% block title %}iWashCars - Booking Carwash{% endblock %}

{% block page_head %}
<!-- Load Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<style>
    /* Input field styling */
    #booking-form input[type="text"],
    #booking-form input[type="email"],
    #booking-form input[type="tel"],
    #booking-form input[type="date"],
    #booking-form input[type="time"],
    #booking-form select,
    #booking-form textarea,
    #service-details,
    .available-spots {
        color: #ffffff !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        backdrop-filter: blur(4px) !important;
        background-color: hsl(0deg 0% 15.11% / 5.1%) !important;
    }

    /* Placeholder text */
    #booking-form input::placeholder,
    #booking-form textarea::placeholder {
        color: rgba(255, 255, 255, 0.5) !important;
    }

    /* Label text */
    #booking-form .label-text,
    #booking-form .label-text-alt {
        color: #ffffff !important;
    }

    /* Select dropdown options */
    #booking-form select option {
        background-color: #000000;
        color: #ffffff;
    }

    /* Focus states */
    #booking-form input:focus,
    #booking-form select:focus,
    #booking-form textarea:focus {
        outline: none;
        border-color: rgba(212, 175, 55, 0.5) !important;
        box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.1);
    }

    /* Disabled inputs */
    #booking-form input:disabled,
    #booking-form select:disabled {
        background-color: #1a1a1a !important;
        color: rgba(255, 255, 255, 0.5) !important;
        cursor: not-allowed;
    }

    /* Autofill styling - override browser defaults */
    #booking-form input:-webkit-autofill,
    #booking-form input:-webkit-autofill:hover,
    #booking-form input:-webkit-autofill:focus,
    #booking-form select:-webkit-autofill,
    #booking-form select:-webkit-autofill:hover,
    #booking-form select:-webkit-autofill:focus,
    #booking-form textarea:-webkit-autofill,
    #booking-form textarea:-webkit-autofill:hover,
    #booking-form textarea:-webkit-autofill:focus  {
        -webkit-text-fill-color: #ffffff !important;
        -webkit-box-shadow: 0 0 0px 1000px hsl(0deg 0% 15.11% / 5.1%) inset !important;
        box-shadow: 0 0 0px 1000px hsl(0deg 0% 15.11% / 5.1%) inset !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        transition: background-color 5000s ease-in-out 0s;
    }

    /* Date and time picker calendar/clock icons - make them white */
    #booking-form input[type="date"]::-webkit-calendar-picker-indicator,
    #booking-form input[type="time"]::-webkit-calendar-picker-indicator {
        filter: invert(1) brightness(100%);
        cursor: pointer;
    }

    /* Submit button styling */
    #submit-booking {
        background: linear-gradient(135deg, #D4AF37 0%, #F4D03F 100%);
        border: 2px solid #D4AF37;
        color: #000000;
        font-weight: 700;
        font-size: 1.125rem;
        padding: 1rem 2rem;
        box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        transition: all 0.3s ease;
    }

    #submit-booking:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(212, 175, 55, 0.6);
        background: linear-gradient(135deg, #F4D03F 0%, #D4AF37 100%);
    }

    #submit-booking:active:not(:disabled) {
        transform: translateY(0);
    }

    #submit-booking:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}

    <!-- Booking Form -->
    <div class="container mx-auto px-4 py-8 hero bg-cover bg-center" style="background-image: url('{% static 'images/home_2.jpg' %}');">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-4xl font-bold text-white text-center mb-8">Book Your Car Wash</h1>

            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-success mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}

            <div class="card bg-base-100 shadow-xl text-white" style="backdrop-filter: blur(4px); border: 1px solid hsla(0,0%,100%,0.12156862745098039); background-color: hsl(0deg 0% 15.11% / 5.1%)">
                <div class="card-body">
                    <form method="post" id="booking-form">
                        {% csrf_token %}

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column - Customer Info -->
                            <div>
                                <h2 class="text-2xl font-bold mb-6">Customer Information</h2>

                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">First Name *</span>
                                        </label>
                                        {{ form.first_name }}
                                        {% if form.first_name.errors %}
                                            <label class="label">
                                                <span class="label-text-alt text-error">{{ form.first_name.errors.0 }}</span>
                                            </label>
                                        {% endif %}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Last Name *</span>
                                        </label>
                                        {{ form.last_name }}
                                        {% if form.last_name.errors %}
                                            <label class="label">
                                                <span class="label-text-alt text-error">{{ form.last_name.errors.0 }}</span>
                                            </label>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="form-control mb-4">
                                    <label class="label">
                                        <span class="label-text">Email Address *</span>
                                    </label>
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.email.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control mb-6">
                                    <label class="label">
                                        <span class="label-text">Phone Number</span>
                                    </label>
                                    {{ form.phone }}
                                    {% if form.phone.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.phone.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <h3 class="text-xl font-bold mb-4">Service Location</h3>

                                <div class="form-control mb-4">
                                    <label class="label">
                                        <span class="label-text">Address *</span>
                                    </label>
                                    {{ form.address }}
                                    {% if form.address.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.address.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">City *</span>
                                        </label>
                                        {{ form.city }}
                                        {% if form.city.errors %}
                                            <label class="label">
                                                <span class="label-text-alt text-error">{{ form.city.errors.0 }}</span>
                                            </label>
                                        {% endif %}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">ZIP Code *</span>
                                        </label>
                                        {{ form.zip_code }}
                                        {% if form.zip_code.errors %}
                                            <label class="label">
                                                <span class="label-text-alt text-error">{{ form.zip_code.errors.0 }}</span>
                                            </label>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Real-time Address Validation Feedback -->
                                <div id="address-validation-feedback" class="mt-4" style="display: none;">
                                    <!-- Validation message will be inserted here -->
                                </div>
                            </div>

                            <!-- Right Column - Service & Schedule -->
                            <div>
                                <h2 class="text-2xl font-bold mb-6">Service & Schedule</h2>

                                <div class="form-control mb-6">
                                    <label class="label">
                                        <span class="label-text">Vehicle Type *</span>
                                    </label>
                                    {{ form.vehicle_type }}
                                    {% if form.vehicle_type.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.vehicle_type.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                    <label class="label">
                                        <span class="label-text-alt">SUV/Large vehicles have a $50 surcharge</span>
                                    </label>
                                </div>

                                <div class="form-control mb-6">
                                    <label class="label">
                                        <span class="label-text">Service Type *</span>
                                    </label>
                                    {{ form.service }}
                                    {% if form.service.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.service.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <!-- Service Details Display -->
                                <div id="service-details" class="p-4 rounded-lg mb-6" style="display: none;">
                                    <h4 class="font-bold mb-2">Service Details</h4>
                                    <div id="service-info" class="text-sm">
                                        <!-- Service details will be populated by JavaScript -->
                                    </div>
                                    <a id="see-details-link" href="#" class="btn btn-link p-0" target="_blank" style="display: none;">
                                        See Full Details
                                    </a>
                                </div>

                                <div class="form-control mb-6">
                                    <label class="label">
                                        <span class="label-text">Preferred Date *</span>
                                    </label>
                                    {{ form.booking_date }}
                                    {% if form.booking_date.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.booking_date.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control mb-6">
                                    <label class="label">
                                        <span class="label-text">Time Slot *</span>
                                    </label>
                                    {{ form.booking_time }}
                                    {% if form.booking_time.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.booking_time.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                    <label class="label">
                                        <span class="label-text-alt">Available slots are 7:00 AM - 9:00 PM (every 30 minutes)</span>
                                    </label>
                                </div>

                                <!-- Available Time Slots Display -->
                                <div class="p-4 rounded-lg mb-6 border available-spots">
                                    <h4 class="font-bold mb-2">Available Time Slots</h4>
                                    <div id="time-slots" class="text-sm">
                                        Select a date to see available time slots
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <!-- Payment Information -->
                        <div class="bg-info/10 p-6 rounded-lg mb-6">
                            <h3 class="text-xl font-bold mb-4 text-center">üí≥ Payment Information</h3>
                            <div class="text-center mb-4" id="deposit-info">
                                <p class="text-lg">
                                    <span class="font-semibold text-primary" id="deposit-amount-display">Deposit Required: Select a service</span>
                                </p>
                                <p class="text-sm" id="deposit-description">
                                    We'll charge a deposit now and collect the remaining amount after service completion.
                                </p>
                            </div>

                            <!-- Stripe Elements will be inserted here -->
                            <div id="payment-element" class="mb-4" style="display: none;">
                                <!-- Stripe Elements will create form elements here -->
                            </div>

                            <div id="payment-messages" role="alert" style="display: none;" class="alert mb-4"></div>
                        </div>

                        <div class="flex justify-center items-center gap-4">
                            <button type="submit" id="submit-booking" class="btn btn-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                                Complete Booking & Pay Deposit
                            </button>
                            <div id="payment-spinner" class="loading loading-spinner loading-lg" style="display: none; color: #D4AF37;"></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block end_js %}

    <script>
        // Stripe configuration
        const stripe = Stripe('{{ stripe_publishable_key }}');

        // Form data
        const unavailableSlots = {{ unavailable_slots|safe }};
        const serviceData = {{ service_data|safe }};
        const bookingDateInput = document.getElementById('booking-date');
        const bookingTimeSelect = document.getElementById('booking-time');
        const timeSlotsDiv = document.getElementById('time-slots');
        const vehicleTypeSelect = document.getElementById('vehicle-type-select');
        const serviceSelect = document.getElementById('service-select');
        const serviceDetailsDiv = document.getElementById('service-details');
        const serviceInfoDiv = document.getElementById('service-info');

        // Payment elements
        let elements;
        let paymentElement;
        let clientSecret;
        let bookingId;

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        bookingDateInput.min = today;

        // Real-time address validation
        const addressInput = document.getElementById('{{ form.address.id_for_label }}');
        const cityInput = document.getElementById('{{ form.city.id_for_label }}');
        const zipInput = document.getElementById('{{ form.zip_code.id_for_label }}');
        const validationFeedback = document.getElementById('address-validation-feedback');
        const submitButton = document.getElementById('submit-booking');
        let validationTimeout = null;
        let addressValidationState = null; // null = not checked, true = valid, false = invalid

        // Check if all required fields are filled
        function checkRequiredFields() {
            const firstName = document.getElementById('{{ form.first_name.id_for_label }}').value.trim();
            const lastName = document.getElementById('{{ form.last_name.id_for_label }}').value.trim();
            const email = document.getElementById('{{ form.email.id_for_label }}').value.trim();
            const address = addressInput.value.trim();
            const city = cityInput.value.trim();
            const zipCode = zipInput.value.trim();
            const vehicleType = vehicleTypeSelect.value;
            const service = serviceSelect.value;
            const bookingDate = bookingDateInput.value;
            const bookingTime = bookingTimeSelect.value;

            return firstName && lastName && email && address && city && zipCode &&
                   vehicleType && service && bookingDate && bookingTime;
        }

        // Update button state based on validation and required fields
        function updateButtonState() {
            const allFieldsFilled = checkRequiredFields();

            // Disable button if:
            // 1. Address is explicitly invalid (outside service area)
            // 2. Required fields are not all filled
            if (addressValidationState === false || !allFieldsFilled) {
                submitButton.disabled = true;
                submitButton.classList.add('btn-disabled');

                // Update button text to show why it's disabled
                if (addressValidationState === false) {
                    submitButton.innerHTML = '‚ö†Ô∏è Address Outside Service Area';
                } else if (!allFieldsFilled) {
                    submitButton.innerHTML = 'üìù Please Fill All Required Fields';
                }
            } else {
                submitButton.disabled = false;
                submitButton.classList.remove('btn-disabled');
                submitButton.innerHTML = 'üìÖ Book My Car';
            }
        }

        // Validate address on blur (when user finishes typing)
        function validateAddress() {
            const address = addressInput.value.trim();
            const city = cityInput.value.trim();
            const zipCode = zipInput.value.trim();

            // Only validate if all fields are filled
            if (!address || !city || !zipCode) {
                validationFeedback.style.display = 'none';
                addressValidationState = null; // Reset validation state
                updateButtonState();
                return;
            }

            // Show loading state
            validationFeedback.style.display = 'block';
            validationFeedback.innerHTML = `
                <div class="alert alert-info">
                    <span class="loading loading-spinner loading-sm"></span>
                    <span>Validating address...</span>
                </div>
            `;

            // Make API call to validate address
            fetch(`/api/validate-address/?address=${encodeURIComponent(address)}&city=${encodeURIComponent(city)}&zip_code=${encodeURIComponent(zipCode)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.valid === true) {
                        // Address is valid
                        addressValidationState = true;
                        validationFeedback.innerHTML = `
                            <div class="alert alert-success">
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div>
                                    <div class="font-bold">‚úì Address is within our service area</div>
                                    <div class="text-sm">${data.message}</div>
                                </div>
                            </div>
                        `;
                    } else if (data.valid === false) {
                        // Address is outside service area
                        addressValidationState = false;
                        validationFeedback.innerHTML = `
                            <div class="alert alert-error">
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div>
                                    <div class="font-bold">‚ö† Address is outside our service area</div>
                                    <div class="text-sm">${data.message}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Validation couldn't be completed (but we'll allow submission)
                        addressValidationState = true; // Allow booking if validation API fails
                        validationFeedback.innerHTML = `
                            <div class="alert alert-warning">
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <div>
                                    <div class="text-sm">${data.message}</div>
                                </div>
                            </div>
                        `;
                    }
                    updateButtonState();
                })
                .catch(error => {
                    console.error('Validation error:', error);
                    addressValidationState = true; // Allow booking if validation API fails
                    validationFeedback.innerHTML = `
                        <div class="alert alert-warning">
                            <span>Could not validate address at this time. You can still proceed with booking.</span>
                        </div>
                    `;
                    updateButtonState();
                });
        }

        // Debounce validation - wait 1000ms after user stops typing
        function debounceValidation() {
            if (validationTimeout) {
                clearTimeout(validationTimeout);
            }
            validationTimeout = setTimeout(validateAddress, 1000);
        }

        // Add event listeners for real-time validation
        if (addressInput && cityInput && zipInput) {
            // Validate on blur (when user leaves the field)
            addressInput.addEventListener('blur', validateAddress);
            cityInput.addEventListener('blur', validateAddress);
            zipInput.addEventListener('blur', validateAddress);

            // Also validate on input with debouncing
            addressInput.addEventListener('input', debounceValidation);
            cityInput.addEventListener('input', debounceValidation);
            zipInput.addEventListener('input', debounceValidation);
        }

        // Add event listeners to all required fields to update button state
        function addRequiredFieldListeners() {
            const requiredFields = [
                document.getElementById('{{ form.first_name.id_for_label }}'),
                document.getElementById('{{ form.last_name.id_for_label }}'),
                document.getElementById('{{ form.email.id_for_label }}'),
                addressInput,
                cityInput,
                zipInput,
                vehicleTypeSelect,
                serviceSelect,
                bookingDateInput,
                bookingTimeSelect
            ];

            requiredFields.forEach(field => {
                if (field) {
                    field.addEventListener('input', updateButtonState);
                    field.addEventListener('change', updateButtonState);
                }
            });
        }

        function updateAvailableTimeSlots() {
            const selectedDate = bookingDateInput.value;
            if (!selectedDate) {
                timeSlotsDiv.innerHTML = 'Select a date to see available time slots';
                return;
            }

            const unavailableForDate = unavailableSlots[selectedDate] || [];
            const allOptions = Array.from(bookingTimeSelect.options);
            const isToday = selectedDate === today;
            const now = new Date();
            const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();

            console.log('Selected date:', selectedDate);
            console.log('All options count:', allOptions.length);
            console.log('Unavailable slots for this date:', unavailableForDate);

            let availableSlots = [];
            let unavailableCount = 0;

            allOptions.forEach(option => {
                if (option.value && option.value !== '') {
                    const [hours, minutes] = option.value.split(':').map(Number);
                    const slotTimeMinutes = hours * 60 + minutes;
                    const isPastTime = isToday && slotTimeMinutes <= currentTimeMinutes;

                    if (unavailableForDate.includes(option.value) || isPastTime) {
                        option.disabled = true;
                        option.style.color = '#999';
                        unavailableCount++;
                    } else {
                        option.disabled = false;
                        option.style.color = '';
                        availableSlots.push(option.text);
                    }
                }
            });

            console.log('Available slots:', availableSlots.length);
            console.log('Unavailable count:', unavailableCount);

            if (availableSlots.length === 0 && allOptions.length > 1) {
                timeSlotsDiv.innerHTML = '<span class="text-error">‚ùå All slots are booked for this date</span>';
            } else if (availableSlots.length === 0) {
                timeSlotsDiv.innerHTML = '<span class="text-warning">‚è≥ Loading time slots...</span>';
                setTimeout(updateAvailableTimeSlots, 500);
            } else {
                timeSlotsDiv.innerHTML = `
                    <span class="text-success">‚úÖ ${availableSlots.length} slots available</span>
                    ${unavailableCount > 0 ? `<br><span class="text-warning">‚ö†Ô∏è ${unavailableCount} slots already booked</span>` : ''}
                `;
            }
        }

        function updateServiceOptions() {
            const selectedVehicleTypeId = vehicleTypeSelect.value;

            // Clear current service options
            serviceSelect.innerHTML = '<option value="">Select a service</option>';

            // Filter services by vehicle type ID and add to select
            Object.entries(serviceData).forEach(([id, service]) => {
                if (String(service.vehicle_type_id) === String(selectedVehicleTypeId)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${service.name} - $${service.price}`;
                    serviceSelect.appendChild(option);
                }
            });

            // Clear service details when vehicle type changes
            serviceDetailsDiv.style.display = 'none';
        }

        function updateServiceDetails() {
            const selectedServiceId = serviceSelect.value;
            const seeDetailsLink = document.getElementById('see-details-link');
            const depositAmountDisplay = document.getElementById('deposit-amount-display');
            const depositDescription = document.getElementById('deposit-description');

            if (!selectedServiceId || !serviceData[selectedServiceId]) {
                serviceDetailsDiv.style.display = 'none';
                seeDetailsLink.style.display = 'none';
                depositAmountDisplay.textContent = 'Deposit Required: Select a service';
                depositDescription.textContent = 'We\'ll charge a deposit now and collect the remaining amount after service completion.';
                return;
            }

            const service = serviceData[selectedServiceId];

            // Update deposit display
            const depositDollars = parseFloat(service.deposit_amount_dollars).toFixed(2);
            depositAmountDisplay.textContent = `Deposit Required: $${depositDollars}`;
            depositDescription.textContent = `We'll charge a $${depositDollars} deposit now and collect the remaining amount after service completion.`;

            // Show only short description (truncate to first 150 characters)
            const shortDescription = service.description.length > 150
                ? service.description.substring(0, 150) + '...'
                : service.description;

            serviceInfoDiv.innerHTML = `
                <p class="text-sm text-gray-300 mb-3">${shortDescription}</p>
            `;

            // Update the see details link
            seeDetailsLink.href = `/service/${selectedServiceId}/`;
            seeDetailsLink.style.display = 'inline-block';
            seeDetailsLink.className = 'text-primary hover:text-primary-focus underline text-sm';

            serviceDetailsDiv.style.display = 'block';
        }

        // Initialize Stripe payment elements
        async function initializeStripeElements() {
            if (!bookingId || !clientSecret) return;

            const appearance = {
                theme: 'stripe',
                variables: {
                    colorPrimary: '#0066cc',
                    colorBackground: '#ffffff',
                    colorText: '#1f2937',
                    colorDanger: '#df1b41',
                    fontFamily: 'system-ui, sans-serif',
                }
            };

            elements = stripe.elements({ appearance, clientSecret });

            paymentElement = elements.create("payment");
            paymentElement.mount("#payment-element");

            document.getElementById('payment-element').style.display = 'block';
        }

        // Create booking and payment intent
        async function createBookingWithPayment(formData) {
            try {
                // First create the booking
                const bookingResponse = await fetch(window.location.pathname, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    }
                });

                if (!bookingResponse.ok) {
                    // If booking creation failed, show the form errors
                    const html = await bookingResponse.text();
                    document.body.innerHTML = html;
                    return false;
                }

                // Parse the response to get booking ID (UUID format)
                const responseUrl = bookingResponse.url;
                const urlMatch = responseUrl.match(/booking\/success\/([0-9a-f-]+)\//);
                if (urlMatch) {
                    bookingId = urlMatch[1];
                } else {
                    throw new Error('Could not extract booking ID from response');
                }

                // Now create payment intent
                const paymentResponse = await fetch('/api/create-payment-intent/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify({
                        booking_id: bookingId
                    })
                });

                const paymentData = await paymentResponse.json();
                if (!paymentResponse.ok) {
                    throw new Error(paymentData.error || 'Failed to create payment intent');
                }

                clientSecret = paymentData.clientSecret;
                await initializeStripeElements();

                return true;
            } catch (error) {
                showPaymentMessage(error.message, 'error');
                return false;
            }
        }

        // Handle form submission
        async function handleSubmit(event) {
            event.preventDefault();

            const submitButton = document.getElementById('submit-booking');
            const spinner = document.getElementById('payment-spinner');

            // Prevent submission if button should be disabled
            if (addressValidationState === false || !checkRequiredFields()) {
                event.stopPropagation();
                return false;
            }

            // Show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '‚è≥ Processing...';
            spinner.style.display = 'block';

            try {
                const form = event.target;
                const formData = new FormData(form);

                // Step 1: Create booking and payment intent
                if (!clientSecret) {
                    const success = await createBookingWithPayment(formData);
                    if (!success) {
                        spinner.style.display = 'none';
                        updateButtonState();
                        return;
                    }
                }

                // Step 2: Confirm payment with Stripe
                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: `${window.location.origin}/booking/success/${bookingId}/`,
                    },
                    redirect: 'if_required'
                });

                if (error) {
                    showPaymentMessage(error.message, 'error');
                } else {
                    // Payment succeeded, confirm with backend
                    const confirmResponse = await fetch('/api/confirm-payment/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        },
                        body: JSON.stringify({
                            payment_intent_id: clientSecret.split('_secret_')[0]
                        })
                    });

                    const confirmData = await confirmResponse.json();
                    if (confirmResponse.ok) {
                        showPaymentMessage('Payment successful! Redirecting...', 'success');
                        setTimeout(() => {
                            window.location.href = `/booking/success/${bookingId}/`;
                        }, 2000);
                    } else {
                        showPaymentMessage(confirmData.error || 'Payment confirmation failed', 'error');
                    }
                }
            } catch (error) {
                showPaymentMessage(error.message, 'error');
            } finally {
                spinner.style.display = 'none';
                updateButtonState(); // Re-evaluate button state based on validation
            }
        }

        // Show payment messages
        function showPaymentMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('payment-messages');
            messagesDiv.style.display = 'block';
            messagesDiv.className = `alert alert-${type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'}`;
            messagesDiv.textContent = message;

            // Auto-hide non-error messages
            if (type !== 'error') {
                setTimeout(() => {
                    messagesDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Wait for DOM to fully load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                bookingDateInput.addEventListener('change', updateAvailableTimeSlots);
                if (vehicleTypeSelect) {
                    vehicleTypeSelect.addEventListener('change', updateServiceOptions);
                }
                if (serviceSelect) {
                    serviceSelect.addEventListener('change', updateServiceDetails);
                }
                document.getElementById('booking-form').addEventListener('submit', handleSubmit);
                addRequiredFieldListeners();
                updateAvailableTimeSlots();
                updateServiceOptions();  // Initialize service options based on default vehicle type
                updateButtonState();  // Initialize button state on page load
            });
        } else {
            bookingDateInput.addEventListener('change', updateAvailableTimeSlots);
            if (vehicleTypeSelect) {
                vehicleTypeSelect.addEventListener('change', updateServiceOptions);
            }
            if (serviceSelect) {
                serviceSelect.addEventListener('change', updateServiceDetails);
            }
            document.getElementById('booking-form').addEventListener('submit', handleSubmit);
            addRequiredFieldListeners();
            updateAvailableTimeSlots();
            updateServiceOptions();  // Initialize service options based on default vehicle type
            updateButtonState();  // Initialize button state on page load
        }
    </script>
{% endblock %}