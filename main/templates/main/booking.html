{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Car Wash - iWashCars</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="{% static 'css/output.css' %}" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <div class="navbar bg-primary text-primary-content">
        <div class="navbar-start">
            <a href="{% url 'index' %}" class="btn btn-ghost text-xl font-bold">🚗 iWashCars</a>
        </div>
        <div class="navbar-center hidden lg:flex">
            <ul class="menu menu-horizontal px-1">
                <li><a href="{% url 'index' %}" class="hover:bg-primary-focus">Home</a></li>
                <li><a class="hover:bg-primary-focus bg-primary-focus">Book Now</a></li>
            </ul>
        </div>
        <div class="navbar-end">
            <a href="{% url 'index' %}" class="btn btn-secondary">Back to Home</a>
        </div>
    </div>

    <!-- Booking Form -->
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-4xl font-bold text-center mb-8">Book Your Car Wash</h1>

            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-success mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}

            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <form method="post" id="booking-form">
                        {% csrf_token %}

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column - Customer Info -->
                            <div>
                                <h2 class="text-2xl font-bold mb-6">Customer Information</h2>

                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">First Name *</span>
                                        </label>
                                        {{ form.first_name }}
                                        {% if form.first_name.errors %}
                                            <label class="label">
                                                <span class="label-text-alt text-error">{{ form.first_name.errors.0 }}</span>
                                            </label>
                                        {% endif %}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">Last Name *</span>
                                        </label>
                                        {{ form.last_name }}
                                        {% if form.last_name.errors %}
                                            <label class="label">
                                                <span class="label-text-alt text-error">{{ form.last_name.errors.0 }}</span>
                                            </label>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="form-control mb-4">
                                    <label class="label">
                                        <span class="label-text">Email Address *</span>
                                    </label>
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.email.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control mb-6">
                                    <label class="label">
                                        <span class="label-text">Phone Number</span>
                                    </label>
                                    {{ form.phone }}
                                    {% if form.phone.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.phone.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <h3 class="text-xl font-bold mb-4">Service Location</h3>

                                <div class="form-control mb-4">
                                    <label class="label">
                                        <span class="label-text">Address *</span>
                                    </label>
                                    {{ form.address }}
                                    {% if form.address.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.address.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">City *</span>
                                        </label>
                                        {{ form.city }}
                                        {% if form.city.errors %}
                                            <label class="label">
                                                <span class="label-text-alt text-error">{{ form.city.errors.0 }}</span>
                                            </label>
                                        {% endif %}
                                    </div>
                                    <div class="form-control">
                                        <label class="label">
                                            <span class="label-text">ZIP Code *</span>
                                        </label>
                                        {{ form.zip_code }}
                                        {% if form.zip_code.errors %}
                                            <label class="label">
                                                <span class="label-text-alt text-error">{{ form.zip_code.errors.0 }}</span>
                                            </label>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column - Service & Schedule -->
                            <div>
                                <h2 class="text-2xl font-bold mb-6">Service & Schedule</h2>

                                <div class="form-control mb-6">
                                    <label class="label">
                                        <span class="label-text">Service Type *</span>
                                    </label>
                                    {{ form.service }}
                                    {% if form.service.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.service.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <!-- Service Details Display -->
                                <div id="service-details" class="bg-base-200 p-4 rounded-lg mb-6" style="display: none;">
                                    <h4 class="font-bold mb-2">Service Details</h4>
                                    <div id="service-info" class="text-sm text-base-content">
                                        <!-- Service details will be populated by JavaScript -->
                                    </div>
                                    <a id="see-details-link" href="#" class="btn btn-link p-0" target="_blank" style="display: none;">
                                        See Full Details
                                    </a>
                                </div>

                                <div class="form-control mb-6">
                                    <label class="label">
                                        <span class="label-text">Preferred Date *</span>
                                    </label>
                                    {{ form.booking_date }}
                                    {% if form.booking_date.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.booking_date.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                </div>

                                <div class="form-control mb-6">
                                    <label class="label">
                                        <span class="label-text">Time Slot *</span>
                                    </label>
                                    {{ form.booking_time }}
                                    {% if form.booking_time.errors %}
                                        <label class="label">
                                            <span class="label-text-alt text-error">{{ form.booking_time.errors.0 }}</span>
                                        </label>
                                    {% endif %}
                                    <label class="label">
                                        <span class="label-text-alt">Available slots are 7:00 AM - 9:00 PM (every 30 minutes)</span>
                                    </label>
                                </div>

                                <!-- Available Time Slots Display -->
                                <div class="bg-base-200 p-4 rounded-lg mb-6">
                                    <h4 class="font-bold mb-2">Available Time Slots</h4>
                                    <div id="time-slots" class="text-sm text-base-content">
                                        Select a date to see available time slots
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <!-- Payment Information -->
                        <div class="bg-info/10 p-6 rounded-lg mb-6">
                            <h3 class="text-xl font-bold mb-4 text-center">💳 Payment Information</h3>
                            <div class="text-center mb-4">
                                <p class="text-lg">
                                    <span class="font-semibold text-primary">Deposit Required: $25.00</span>
                                </p>
                                <p class="text-sm text-gray-600">
                                    We'll charge a $25 deposit now and collect the remaining amount after service completion.
                                </p>
                            </div>

                            <!-- Stripe Elements will be inserted here -->
                            <div id="payment-element" class="mb-4" style="display: none;">
                                <!-- Stripe Elements will create form elements here -->
                            </div>

                            <div id="payment-messages" role="alert" style="display: none;" class="alert mb-4"></div>
                        </div>

                        <div class="flex justify-center">
                            <button type="submit" id="submit-booking" class="btn btn-primary btn-lg">
                                📅 Book My Car Wash & Pay Deposit
                            </button>
                            <div id="payment-spinner" class="loading loading-spinner loading-lg text-primary ml-4" style="display: none;"></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Stripe configuration
        const stripe = Stripe('{{ stripe_publishable_key }}');
        const depositAmount = {{ deposit_amount }};

        // Form data
        const unavailableSlots = {{ unavailable_slots|safe }};
        const serviceData = {{ service_data|safe }};
        const bookingDateInput = document.getElementById('booking-date');
        const bookingTimeSelect = document.getElementById('booking-time');
        const timeSlotsDiv = document.getElementById('time-slots');
        const serviceSelect = document.getElementById('service-select');
        const serviceDetailsDiv = document.getElementById('service-details');
        const serviceInfoDiv = document.getElementById('service-info');

        // Payment elements
        let elements;
        let paymentElement;
        let clientSecret;
        let bookingId;

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        bookingDateInput.min = today;

        function updateAvailableTimeSlots() {
            const selectedDate = bookingDateInput.value;
            if (!selectedDate) {
                timeSlotsDiv.innerHTML = 'Select a date to see available time slots';
                return;
            }

            const unavailableForDate = unavailableSlots[selectedDate] || [];
            const allOptions = Array.from(bookingTimeSelect.options);
            const isToday = selectedDate === today;
            const now = new Date();
            const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();

            console.log('Selected date:', selectedDate);
            console.log('All options count:', allOptions.length);
            console.log('Unavailable slots for this date:', unavailableForDate);

            let availableSlots = [];
            let unavailableCount = 0;

            allOptions.forEach(option => {
                if (option.value && option.value !== '') {
                    const [hours, minutes] = option.value.split(':').map(Number);
                    const slotTimeMinutes = hours * 60 + minutes;
                    const isPastTime = isToday && slotTimeMinutes <= currentTimeMinutes;

                    if (unavailableForDate.includes(option.value) || isPastTime) {
                        option.disabled = true;
                        option.style.color = '#999';
                        unavailableCount++;
                    } else {
                        option.disabled = false;
                        option.style.color = '';
                        availableSlots.push(option.text);
                    }
                }
            });

            console.log('Available slots:', availableSlots.length);
            console.log('Unavailable count:', unavailableCount);

            if (availableSlots.length === 0 && allOptions.length > 1) {
                timeSlotsDiv.innerHTML = '<span class="text-error">❌ All slots are booked for this date</span>';
            } else if (availableSlots.length === 0) {
                timeSlotsDiv.innerHTML = '<span class="text-warning">⏳ Loading time slots...</span>';
                setTimeout(updateAvailableTimeSlots, 500);
            } else {
                timeSlotsDiv.innerHTML = `
                    <span class="text-success">✅ ${availableSlots.length} slots available</span>
                    ${unavailableCount > 0 ? `<br><span class="text-warning">⚠️ ${unavailableCount} slots already booked</span>` : ''}
                `;
            }
        }

        function updateServiceDetails() {
            const selectedServiceId = serviceSelect.value;
            const seeDetailsLink = document.getElementById('see-details-link');

            if (!selectedServiceId || !serviceData[selectedServiceId]) {
                serviceDetailsDiv.style.display = 'none';
                seeDetailsLink.style.display = 'none';
                return;
            }

            const service = serviceData[selectedServiceId];
            const duration = service.duration_minutes;
            const hours = Math.floor(duration / 60);
            const minutes = duration % 60;
            const durationText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

            serviceInfoDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p><strong>Service:</strong> ${service.name}</p>
                        <p><strong>Price:</strong> $${service.price}</p>
                        <p><strong>Duration:</strong> ${durationText}</p>
                    </div>
                    <div>
                        <p><strong>Description:</strong></p>
                        <p class="text-sm">${service.description}</p>
                    </div>
                </div>
            `;

            // Update the see details link
            seeDetailsLink.href = `/service/${selectedServiceId}/`;
            seeDetailsLink.style.display = 'inline-block';

            serviceDetailsDiv.style.display = 'block';
        }

        // Initialize Stripe payment elements
        async function initializeStripeElements() {
            if (!bookingId || !clientSecret) return;

            const appearance = {
                theme: 'stripe',
                variables: {
                    colorPrimary: '#0066cc',
                    colorBackground: '#ffffff',
                    colorText: '#1f2937',
                    colorDanger: '#df1b41',
                    fontFamily: 'system-ui, sans-serif',
                }
            };

            elements = stripe.elements({ appearance, clientSecret });

            paymentElement = elements.create("payment");
            paymentElement.mount("#payment-element");

            document.getElementById('payment-element').style.display = 'block';
        }

        // Create booking and payment intent
        async function createBookingWithPayment(formData) {
            try {
                // First create the booking
                const bookingResponse = await fetch(window.location.pathname, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    }
                });

                if (!bookingResponse.ok) {
                    // If booking creation failed, show the form errors
                    const html = await bookingResponse.text();
                    document.body.innerHTML = html;
                    return false;
                }

                // Parse the response to get booking ID (assuming redirect to success page)
                const responseUrl = bookingResponse.url;
                const urlMatch = responseUrl.match(/booking\/success\/(\d+)\//);
                if (urlMatch) {
                    bookingId = urlMatch[1];
                } else {
                    throw new Error('Could not extract booking ID from response');
                }

                // Now create payment intent
                const paymentResponse = await fetch('/api/create-payment-intent/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify({
                        booking_id: bookingId
                    })
                });

                const paymentData = await paymentResponse.json();
                if (!paymentResponse.ok) {
                    throw new Error(paymentData.error || 'Failed to create payment intent');
                }

                clientSecret = paymentData.clientSecret;
                await initializeStripeElements();

                return true;
            } catch (error) {
                showPaymentMessage(error.message, 'error');
                return false;
            }
        }

        // Handle form submission
        async function handleSubmit(event) {
            event.preventDefault();

            const submitButton = document.getElementById('submit-booking');
            const spinner = document.getElementById('payment-spinner');

            // Show loading state
            submitButton.disabled = true;
            spinner.style.display = 'block';

            try {
                const form = event.target;
                const formData = new FormData(form);

                // Step 1: Create booking and payment intent
                if (!clientSecret) {
                    const success = await createBookingWithPayment(formData);
                    if (!success) {
                        submitButton.disabled = false;
                        spinner.style.display = 'none';
                        return;
                    }
                }

                // Step 2: Confirm payment with Stripe
                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: `${window.location.origin}/booking/success/${bookingId}/`,
                    },
                    redirect: 'if_required'
                });

                if (error) {
                    showPaymentMessage(error.message, 'error');
                } else {
                    // Payment succeeded, confirm with backend
                    const confirmResponse = await fetch('/api/confirm-payment/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        },
                        body: JSON.stringify({
                            payment_intent_id: clientSecret.split('_secret_')[0]
                        })
                    });

                    const confirmData = await confirmResponse.json();
                    if (confirmResponse.ok) {
                        showPaymentMessage('Payment successful! Redirecting...', 'success');
                        setTimeout(() => {
                            window.location.href = `/booking/success/${bookingId}/`;
                        }, 2000);
                    } else {
                        showPaymentMessage(confirmData.error || 'Payment confirmation failed', 'error');
                    }
                }
            } catch (error) {
                showPaymentMessage(error.message, 'error');
            } finally {
                submitButton.disabled = false;
                spinner.style.display = 'none';
            }
        }

        // Show payment messages
        function showPaymentMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('payment-messages');
            messagesDiv.style.display = 'block';
            messagesDiv.className = `alert alert-${type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'}`;
            messagesDiv.textContent = message;

            // Auto-hide non-error messages
            if (type !== 'error') {
                setTimeout(() => {
                    messagesDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Wait for DOM to fully load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                bookingDateInput.addEventListener('change', updateAvailableTimeSlots);
                if (serviceSelect) {
                    serviceSelect.addEventListener('change', updateServiceDetails);
                }
                document.getElementById('booking-form').addEventListener('submit', handleSubmit);
                updateAvailableTimeSlots();
                updateServiceDetails();
            });
        } else {
            bookingDateInput.addEventListener('change', updateAvailableTimeSlots);
            if (serviceSelect) {
                serviceSelect.addEventListener('change', updateServiceDetails);
            }
            document.getElementById('booking-form').addEventListener('submit', handleSubmit);
            updateAvailableTimeSlots();
            updateServiceDetails();
        }
    </script>
</body>
</html>